{"version":3,"sources":["getUserMedia.ts"],"names":["NativeModules","RTCUtil","MediaStream","MediaStreamError","permissions","WebRTCModule","getUserMedia","constraints","Promise","reject","TypeError","audio","video","normalizeConstraints","reqPermissions","push","request","name","resolve","all","then","results","audioPerm","videoPerm","error","message","success","id","tracks","trackInfo","c","kind","deepClone","info","streamId","streamReactTag","failure","type"],"mappings":"AACA,SAASA,aAAT,QAA8B,cAA9B;AACA,OAAO,KAAKC,OAAZ,MAAyB,WAAzB;AAEA,OAAOC,WAAP,MAAwB,eAAxB;AACA,OAAOC,gBAAP,MAA6B,oBAA7B;AACA,OAAOC,WAAP,MAAwB,eAAxB;AAEA,MAAM;AAAEC,EAAAA;AAAF,IAAmBL,aAAzB;AAOA,eAAe,SAASM,YAAT,GAAqD;AAAA,MAA/BC,WAA+B,uEAAJ,EAAI;;AAChE;AACA;AACA;AACA,MAAI,OAAOA,WAAP,KAAuB,QAA3B,EAAqC;AACjC,WAAOC,OAAO,CAACC,MAAR,CAAe,IAAIC,SAAJ,CAAc,iCAAd,CAAf,CAAP;AACH;;AAED,MACI,CAAC,OAAOH,WAAW,CAACI,KAAnB,KAA6B,WAA7B,IAA4C,CAACJ,WAAW,CAACI,KAA1D,MACC,OAAOJ,WAAW,CAACK,KAAnB,KAA6B,WAA7B,IAA4C,CAACL,WAAW,CAACK,KAD1D,CADJ,EAGE;AACE,WAAOJ,OAAO,CAACC,MAAR,CAAe,IAAIC,SAAJ,CAAc,gCAAd,CAAf,CAAP;AACH,GAb+D,CAehE;;;AACAH,EAAAA,WAAW,GAAGN,OAAO,CAACY,oBAAR,CAA6BN,WAA7B,CAAd,CAhBgE,CAkBhE;;AACA,QAAMO,cAAuC,GAAG,EAAhD;;AACA,MAAIP,WAAW,CAACI,KAAhB,EAAuB;AACnBG,IAAAA,cAAc,CAACC,IAAf,CAAoBX,WAAW,CAACY,OAAZ,CAAoB;AAAEC,MAAAA,IAAI,EAAE;AAAR,KAApB,CAApB;AACH,GAFD,MAEO;AACHH,IAAAA,cAAc,CAACC,IAAf,CAAoBP,OAAO,CAACU,OAAR,CAAgB,KAAhB,CAApB;AACH;;AACD,MAAIX,WAAW,CAACK,KAAhB,EAAuB;AACnBE,IAAAA,cAAc,CAACC,IAAf,CAAoBX,WAAW,CAACY,OAAZ,CAAoB;AAAEC,MAAAA,IAAI,EAAE;AAAR,KAApB,CAApB;AACH,GAFD,MAEO;AACHH,IAAAA,cAAc,CAACC,IAAf,CAAoBP,OAAO,CAACU,OAAR,CAAgB,KAAhB,CAApB;AACH;;AAED,SAAO,IAAIV,OAAJ,CAAY,CAACU,OAAD,EAAUT,MAAV,KAAqB;AACpCD,IAAAA,OAAO,CAACW,GAAR,CAAYL,cAAZ,EAA4BM,IAA5B,CAAiCC,OAAO,IAAI;AACxC,YAAM,CAACC,SAAD,EAAYC,SAAZ,IAAyBF,OAA/B,CADwC,CAGxC;;AAEA,UAAI,CAACC,SAAD,IAAc,CAACC,SAAnB,EAA8B;AAC1B;AACA;AACA,cAAMC,KAAK,GAAG;AACVC,UAAAA,OAAO,EAAE,oBADC;AAEVR,UAAAA,IAAI,EAAE;AAFI,SAAd;AAIAR,QAAAA,MAAM,CAAC,IAAIN,gBAAJ,CAAqBqB,KAArB,CAAD,CAAN;AAEA;AACH;;AAEDF,MAAAA,SAAS,IAAI,OAAOf,WAAW,CAACI,KAAhC;AACAY,MAAAA,SAAS,IAAI,OAAOhB,WAAW,CAACK,KAAhC;;AAEA,YAAMc,OAAO,GAAG,CAACC,EAAD,EAAKC,MAAL,KAAgB;AAC5B;AACA,aAAK,MAAMC,SAAX,IAAwBD,MAAxB,EAAgC;AAC5B,gBAAME,CAAC,GAAGvB,WAAW,CAACsB,SAAS,CAACE,IAAX,CAArB;;AACA,cAAI,OAAOD,CAAP,KAAa,QAAjB,EAA2B;AACvBD,YAAAA,SAAS,CAACtB,WAAV,GAAwBN,OAAO,CAAC+B,SAAR,CAAkBF,CAAlB,CAAxB;AACH;AACJ;;AAED,cAAMG,IAAI,GAAG;AACTC,UAAAA,QAAQ,EAAEP,EADD;AAETQ,UAAAA,cAAc,EAAER,EAFP;AAGTC,UAAAA;AAHS,SAAb;AAMAV,QAAAA,OAAO,CAAC,IAAIhB,WAAJ,CAAgB+B,IAAhB,CAAD,CAAP;AACH,OAhBD;;AAkBA,YAAMG,OAAO,GAAG,CAACC,IAAD,EAAOZ,OAAP,KAAmB;AAC/B,YAAID,KAAJ;;AACA,gBAAQa,IAAR;AACI,eAAK,WAAL;AACIb,YAAAA,KAAK,GAAG,IAAId,SAAJ,CAAce,OAAd,CAAR;AACA;AAHR;;AAKA,YAAI,CAACD,KAAL,EAAY;AACRA,UAAAA,KAAK,GAAG,IAAIrB,gBAAJ,CAAqB;AAAEsB,YAAAA,OAAF;AAAWR,YAAAA,IAAI,EAAEoB;AAAjB,WAArB,CAAR;AACH;;AAED5B,QAAAA,MAAM,CAACe,KAAD,CAAN;AACH,OAZD;;AAcAnB,MAAAA,YAAY,CAACC,YAAb,CAA0BC,WAA1B,EAAuCmB,OAAvC,EAAgDU,OAAhD;AACH,KArDD;AAsDH,GAvDM,CAAP;AAwDH","sourcesContent":["\nimport { NativeModules } from 'react-native';\nimport * as RTCUtil from './RTCUtil';\n\nimport MediaStream from './MediaStream';\nimport MediaStreamError from './MediaStreamError';\nimport permissions from './Permissions';\n\nconst { WebRTCModule } = NativeModules;\n\ninterface Constraints {\n    audio?: boolean | object;\n    video?: boolean | object;\n}\n\nexport default function getUserMedia(constraints: Constraints = {}) {\n    // According to\n    // https://www.w3.org/TR/mediacapture-streams/#dom-mediadevices-getusermedia,\n    // the constraints argument is a dictionary of type MediaStreamConstraints.\n    if (typeof constraints !== 'object') {\n        return Promise.reject(new TypeError('constraints is not a dictionary'));\n    }\n\n    if (\n        (typeof constraints.audio === 'undefined' || !constraints.audio) &&\n        (typeof constraints.video === 'undefined' || !constraints.video)\n    ) {\n        return Promise.reject(new TypeError('audio and/or video is required'));\n    }\n\n    // Normalize constraints.\n    constraints = RTCUtil.normalizeConstraints(constraints);\n\n    // Request required permissions\n    const reqPermissions: Array<Promise<boolean>> = [];\n    if (constraints.audio) {\n        reqPermissions.push(permissions.request({ name: 'microphone' }));\n    } else {\n        reqPermissions.push(Promise.resolve(false));\n    }\n    if (constraints.video) {\n        reqPermissions.push(permissions.request({ name: 'camera' }));\n    } else {\n        reqPermissions.push(Promise.resolve(false));\n    }\n\n    return new Promise((resolve, reject) => {\n        Promise.all(reqPermissions).then(results => {\n            const [audioPerm, videoPerm] = results;\n\n            // Check permission results and remove unneeded permissions.\n\n            if (!audioPerm && !videoPerm) {\n                // https://www.w3.org/TR/mediacapture-streams/#dom-mediadevices-getusermedia\n                // step 4\n                const error = {\n                    message: 'Permission denied.',\n                    name: 'SecurityError'\n                };\n                reject(new MediaStreamError(error));\n\n                return;\n            }\n\n            audioPerm || delete constraints.audio;\n            videoPerm || delete constraints.video;\n\n            const success = (id, tracks) => {\n                // Store initial constraints.\n                for (const trackInfo of tracks) {\n                    const c = constraints[trackInfo.kind];\n                    if (typeof c === 'object') {\n                        trackInfo.constraints = RTCUtil.deepClone(c);\n                    }\n                }\n\n                const info = {\n                    streamId: id,\n                    streamReactTag: id,\n                    tracks\n                };\n\n                resolve(new MediaStream(info));\n            };\n\n            const failure = (type, message) => {\n                let error;\n                switch (type) {\n                    case 'TypeError':\n                        error = new TypeError(message);\n                        break;\n                }\n                if (!error) {\n                    error = new MediaStreamError({ message, name: type });\n                }\n\n                reject(error);\n            };\n\n            WebRTCModule.getUserMedia(constraints, success, failure);\n        });\n    });\n}\n"]}